<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Peer-to-Peer Cue System --- Sender</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <button id="btSend">Send message</button>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="text/javascript">
      var lastPeerId = null
      var peer = null // own peer object
      var conn = null
      var recvIdInput = document.getElementById("receiver-id")
      var status = document.getElementById("status")
      var message = document.getElementById("message")
      var goButton = document.getElementById("goButton")
      var resetButton = document.getElementById("resetButton")
      var fadeButton = document.getElementById("fadeButton")
      var offButton = document.getElementById("offButton")
      var sendMessageBox = document.getElementById("sendMessageBox")
      var sendButton = document.getElementById("sendButton")
      var clearMsgsButton = document.getElementById("clearMsgsButton")
      var connectButton = document.getElementById("connect-button")
      var cueString = '<span class="cueMsg">Cue: </span>'

      // Create own peer object with connection to shared PeerJS server
      peer = new Peer(null, {
        debug: 2,
      })

      const connect = () => {
        // Create connection to destination peer specified in the input field
        const id = new URLSearchParams(location.search).get("id")

        console.log("connecting to:", id)
        conn = peer.connect(id)

        conn.on("open", function () {
          console.log("Connected to: " + conn.peer)
        })
        // Handle incoming data (messages only since this is the signal sender)
        conn.on("data", function (data) {
          console.log("Received:", data)
        })
        conn.on("close", function () {
          console.log("Connection closed, trying to reconnect...")
          connect()
        })
      }

      peer.on("open", function () {
        // Workaround for peer.reconnect deleting previous id
        peer.id = peer.id || lastPeerId
        console.log("ID: " + peer.id)
        connect()
      })
      peer.on("disconnected", function () {
        console.log("Connection lost. Please reconnect")

        // Workaround for peer.reconnect deleting previous id
        peer.id = lastPeerId
        peer._lastServerId = lastPeerId
        peer.reconnect()
      })
      peer.on("close", function () {
        conn = null
        console.log("Connection destroyed")
      })
      peer.on("error", function (err) {
        console.log(err)
        alert("" + err)
      })

      /**
       * Create the connection between the two Peers.
       *
       * Sets up callbacks that handle any events related to the
       * connection and data received on it.
       */

      document
        .getElementById("btSend")
        .addEventListener("click", () =>
          conn.send({ message: "test message", time: new Date().getTime() })
        )
    </script>
  </body>
</html>
